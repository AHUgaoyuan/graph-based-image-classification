from nose.tools import *
from numpy import testing as np_test

import networkx as nx

from .receptive_fields import receptive_fields
from .labeling import order


def test_receptive_fields():
    # Create test graph with custom ordering.
    graph = nx.Graph()

    graph.add_node('Ben', {'order': 4, 'red': 1.0, 'green': 2.0, 'blue': 3.0})
    graph.add_node('Anna', {'order': 1, 'red': 4.0, 'green': 5.0, 'blue': 6.0})
    graph.add_node('Cara', {'order': 0, 'red': 7.0, 'green': 8.0, 'blue': 9.0})
    graph.add_node('Dana', {'order': 3, 'red': 10.0, 'green': 11.0,
                            'blue': 12.0})
    graph.add_node('Evan', {'order': 2, 'red': 13.0, 'green': 14.0,
                            'blue': 15.0})
    graph.add_node('Frank', {'order': 5, 'red': 16.0, 'green': 17.0,
                             'blue': 18.0})

    graph.add_edge('Ben', 'Anna')
    graph.add_edge('Anna', 'Cara')
    graph.add_edge('Cara', 'Dana')
    graph.add_edge('Cara', 'Evan')
    graph.add_edge('Dana', 'Evan')
    graph.add_edge('Dana', 'Frank')
    graph.add_edge('Evan', 'Frank')

    def node_features(node_attributes):
        return [
            node_attributes['red'],
            node_attributes['green'],
            node_attributes['blue'],
        ]

    fields = receptive_fields(graph, order, 1, 6, 4, node_features, 3)

    assert_equals(fields.shape, (1, 6 * 4, 3))

    # The first neighborhood nodes are centered around `Cara`. The neighborhood
    # of `Cara` is ['Cara', 'Anna', 'Evan', 'Dana'].
    np_test.assert_array_equal(fields[0][0], [7.0, 8.0, 9.0])
    np_test.assert_array_equal(fields[0][1], [4.0, 5.0, 6.0])
    np_test.assert_array_equal(fields[0][2], [13.0, 14.0, 15.0])
    np_test.assert_array_equal(fields[0][3], [10.0, 11.0, 12.0])

    # The second neighborhood nodes are centered around `Anna`. The
    # neighborhood of `Anna` is ['Anna', 'Cara', 'Ben', 'Evan'].
    np_test.assert_array_equal(fields[0][4], [4.0, 5.0, 6.0])
    np_test.assert_array_equal(fields[0][5], [7.0, 8.0, 9.0])
    np_test.assert_array_equal(fields[0][6], [1.0, 2.0, 3.0])
    np_test.assert_array_equal(fields[0][7], [13.0, 14.0, 15.0])

    # The third neighborhood nodes are centered around `Evan`. The neighborhood
    # of `Evan` is ['Evan', 'Cara', 'Dana', 'Frank'].
    np_test.assert_array_equal(fields[0][8], [13.0, 14.0, 15.0])
    np_test.assert_array_equal(fields[0][9], [7.0, 8.0, 9.0])
    np_test.assert_array_equal(fields[0][10], [10.0, 11.0, 12.0])
    np_test.assert_array_equal(fields[0][11], [16.0, 17.0, 18.0])

    # The fourth neighborhood nodes are centered around `Dana`. The
    # neighborhood of `Dana` is ['Dana', 'Cara', 'Evan', 'Frank'].
    np_test.assert_array_equal(fields[0][12], [10.0, 11.0, 12.0])
    np_test.assert_array_equal(fields[0][13], [7.0, 8.0, 9.0])
    np_test.assert_array_equal(fields[0][14], [13.0, 14.0, 15.0])
    np_test.assert_array_equal(fields[0][15], [16.0, 17.0, 18.0])

    # The fifth neighborhood nodes are centered around `Ben`. The neighborhood
    # of `Ben` is ['Ben', 'Anna', 'Cara', 'Evan'].
    np_test.assert_array_equal(fields[0][16], [1.0, 2.0, 3.0])
    np_test.assert_array_equal(fields[0][17], [4.0, 5.0, 6.0])
    np_test.assert_array_equal(fields[0][18], [7.0, 8.0, 9.0])
    np_test.assert_array_equal(fields[0][19], [13.0, 14.0, 15.0])

    # The sixth neighborhood nodes are centered around `Frank`. The
    # neighborhood of `Frank` is ['Frank', 'Evan', 'Dana', 'Cara'].
    np_test.assert_array_equal(fields[0][20], [16.0, 17.0, 18.0])
    np_test.assert_array_equal(fields[0][21], [13.0, 14.0, 15.0])
    np_test.assert_array_equal(fields[0][22], [10.0, 11.0, 12.0])
    np_test.assert_array_equal(fields[0][23], [7.0, 8.0, 9.0])
